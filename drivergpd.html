<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A to Z Packers & Movers - GPS Tracking</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=geometry,places"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .logo {
            color: #667eea;
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .tagline {
            color: #666;
            font-size: 1.1rem;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .map-container {
            height: 400px;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .status-timeline {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            position: relative;
        }

        .status-timeline::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e1e5e9;
            z-index: 1;
        }

        .status-step {
            background: white;
            border: 3px solid #e1e5e9;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 2;
            font-weight: bold;
            color: #666;
        }

        .status-step.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .status-step.completed {
            border-color: #28a745;
            background: #28a745;
            color: white;
        }

        .status-label {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9rem;
            font-weight: 600;
            color: #666;
            white-space: nowrap;
        }

        .trip-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .info-card .icon {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 10px;
        }

        .info-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .info-card .label {
            color: #666;
            font-size: 0.9rem;
        }

        .consignment-list {
            display: grid;
            gap: 20px;
        }

        .consignment-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .consignment-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .consignment-id {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-started {
            background: #fff3cd;
            color: #856404;
        }

        .status-enroute {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-reached {
            background: #d4edda;
            color: #155724;
        }

        .status-delivered {
            background: #d1ecf1;
            color: #0c5460;
        }

        .delay-alert {
            background: #f8d7da;
            color: #721c24;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #dc3545;
        }

        .tracking-link {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #b3d9ff;
        }

        .tracking-link input {
            background: white;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            width: 100%;
            margin: 10px 0;
        }

        .notification-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .notification {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
                gap: 10px;
            }

            .trip-info {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-truck"></i> A to Z Packers & Movers
            </div>
            <div class="tagline">Professional GPS Tracking System</div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('driver')">
                <i class="fas fa-user-tie"></i> Driver Portal
            </button>
            <button class="nav-tab" onclick="showTab('customer')">
                <i class="fas fa-user"></i> Customer Tracking
            </button>
            <button class="nav-tab" onclick="showTab('admin')">
                <i class="fas fa-cog"></i> Admin Dashboard
            </button>
        </div>

        <!-- Driver Portal -->
        <div id="driver" class="tab-content active">
            <h2><i class="fas fa-route"></i> Driver Portal</h2>
            
            <div class="form-group">
                <label>Driver Name</label>
                <input type="text" id="driverName" placeholder="Enter your name">
            </div>

            <div class="form-group">
                <label>Vehicle Number</label>
                <input type="text" id="vehicleNumber" placeholder="e.g., MH12AB1234">
            </div>

            <div class="form-group">
                <label>Starting Point</label>
                <input type="text" id="startPoint" placeholder="Enter pickup location">
            </div>

            <div class="form-group">
                <label>Destination</label>
                <input type="text" id="destination" placeholder="Enter delivery location">
            </div>

            <div class="form-group">
                <label>Customer Contact</label>
                <input type="tel" id="customerContact" placeholder="Customer phone number">
            </div>

            <button class="btn" onclick="startTrip()">
                <i class="fas fa-play"></i> Start Trip
            </button>

            <div id="tripDetails" style="display: none;">
                <div class="trip-info">
                    <div class="info-card">
                        <div class="icon"><i class="fas fa-route"></i></div>
                        <div class="value" id="tripDistance">0 km</div>
                        <div class="label">Distance</div>
                    </div>
                    <div class="info-card">
                        <div class="icon"><i class="fas fa-clock"></i></div>
                        <div class="value" id="tripETA">0 min</div>
                        <div class="label">ETA</div>
                    </div>
                    <div class="info-card">
                        <div class="icon"><i class="fas fa-map-marker-alt"></i></div>
                        <div class="value" id="currentLocation">Tracking...</div>
                        <div class="label">Current Location</div>
                    </div>
                </div>

                <div class="status-timeline">
                    <div class="status-step completed" id="driverStep1">
                        <i class="fas fa-play"></i>
                        <div class="status-label">Started</div>
                    </div>
                    <div class="status-step active" id="driverStep2">
                        <i class="fas fa-truck"></i>
                        <div class="status-label">En Route</div>
                    </div>
                    <div class="status-step" id="driverStep3">
                        <i class="fas fa-map-marker-alt"></i>
                        <div class="status-label">Reached</div>
                    </div>
                    <div class="status-step" id="driverStep4">
                        <i class="fas fa-check"></i>
                        <div class="status-label">Delivered</div>
                    </div>
                </div>

                <div class="map-container">
                    <div id="driverMap" style="height: 100%; width: 100%;"></div>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button class="btn btn-success" onclick="updateStatus('reached')">
                        <i class="fas fa-map-marker-alt"></i> Mark as Reached
                    </button>
                    <button class="btn btn-success" onclick="updateStatus('delivered')">
                        <i class="fas fa-check"></i> Mark as Delivered
                    </button>
                    <button class="btn btn-danger" onclick="endTrip()">
                        <i class="fas fa-stop"></i> End Trip
                    </button>
                </div>

                <div class="tracking-link">
                    <strong>Customer Tracking Link:</strong>
                    <input type="text" id="trackingLink" readonly>
                    <button class="btn" onclick="copyTrackingLink()">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                </div>
            </div>
        </div>

        <!-- Customer Tracking -->
        <div id="customer" class="tab-content">
            <h2><i class="fas fa-search"></i> Track Your Consignment</h2>
            
            <div class="form-group">
                <label>Tracking ID</label>
                <input type="text" id="trackingId" placeholder="Enter your tracking ID">
            </div>

            <button class="btn" onclick="trackConsignment()">
                <i class="fas fa-search"></i> Track Now
            </button>

            <div id="trackingResults" style="display: none;">
                <div class="trip-info">
                    <div class="info-card">
                        <div class="icon"><i class="fas fa-truck"></i></div>
                        <div class="value" id="customerVehicle">MH12AB1234</div>
                        <div class="label">Vehicle Number</div>
                    </div>
                    <div class="info-card">
                        <div class="icon"><i class="fas fa-user-tie"></i></div>
                        <div class="value" id="customerDriver">John Doe</div>
                        <div class="label">Driver Name</div>
                    </div>
                    <div class="info-card">
                        <div class="icon"><i class="fas fa-clock"></i></div>
                        <div class="value" id="customerETA">45 min</div>
                        <div class="label">ETA</div>
                    </div>
                </div>

                <div class="status-timeline">
                    <div class="status-step completed">
                        <i class="fas fa-play"></i>
                        <div class="status-label">Picked Up</div>
                    </div>
                    <div class="status-step active">
                        <i class="fas fa-truck"></i>
                        <div class="status-label">In Transit</div>
                    </div>
                    <div class="status-step">
                        <i class="fas fa-map-marker-alt"></i>
                        <div class="status-label">Near Destination</div>
                    </div>
                    <div class="status-step">
                        <i class="fas fa-check"></i>
                        <div class="status-label">Delivered</div>
                    </div>
                </div>

                <div class="map-container">
                    <div id="customerMap" style="height: 100%; width: 100%;"></div>
                </div>

                <div class="notification-panel">
                    <h3><i class="fas fa-bell"></i> Live Updates</h3>
                    <div class="notification">
                        <strong>15:30</strong> - Your truck is currently 25 km away from destination
                    </div>
                    <div class="notification">
                        <strong>15:15</strong> - Driver has started the journey from pickup location
                    </div>
                    <div class="notification">
                        <strong>15:00</strong> - Your consignment has been loaded and secured
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin" class="tab-content">
            <h2><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h2>
            
            <div class="filters">
                <div class="form-group">
                    <label>Filter by Vehicle</label>
                    <select id="vehicleFilter">
                        <option value="">All Vehicles</option>
                        <option value="MH12AB1234">MH12AB1234</option>
                        <option value="MH12CD5678">MH12CD5678</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Filter by Status</label>
                    <select id="statusFilter">
                        <option value="">All Status</option>
                        <option value="started">Started</option>
                        <option value="enroute">En Route</option>
                        <option value="reached">Reached</option>
                        <option value="delivered">Delivered</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Search</label>
                    <input type="text" id="searchFilter" placeholder="Search by driver, customer...">
                </div>
            </div>

            <div class="trip-info">
                <div class="info-card">
                    <div class="icon"><i class="fas fa-truck"></i></div>
                    <div class="value">12</div>
                    <div class="label">Active Trips</div>
                </div>
                <div class="info-card">
                    <div class="icon"><i class="fas fa-clock"></i></div>
                    <div class="value">3</div>
                    <div class="label">Delayed Trips</div>
                </div>
                <div class="info-card">
                    <div class="icon"><i class="fas fa-check"></i></div>
                    <div class="value">45</div>
                    <div class="label">Completed Today</div>
                </div>
                <div class="info-card">
                    <div class="icon"><i class="fas fa-route"></i></div>
                    <div class="value">1,250 km</div>
                    <div class="label">Total Distance</div>
                </div>
            </div>

            <div class="consignment-list" id="consignmentList">
                <div class="consignment-card">
                    <div class="consignment-header">
                        <div class="consignment-id">TRK001 - MH12AB1234</div>
                        <div class="status-badge status-enroute">En Route</div>
                    </div>
                    <div><strong>Driver:</strong> Rajesh Kumar</div>
                    <div><strong>Route:</strong> Mumbai → Pune</div>
                    <div><strong>Customer:</strong> +91 98765 43210</div>
                    <div><strong>ETA:</strong> 2:30 PM (On Time)</div>
                    <button class="btn" style="margin-top: 10px;" onclick="viewConsignmentDetails('TRK001')">
                        <i class="fas fa-eye"></i> View Details
                    </button>
                </div>

                <div class="consignment-card">
                    <div class="consignment-header">
                        <div class="consignment-id">TRK002 - MH12CD5678</div>
                        <div class="status-badge status-started">Started</div>
                    </div>
                    <div><strong>Driver:</strong> Suresh Patil</div>
                    <div><strong>Route:</strong> Delhi → Jaipur</div>
                    <div><strong>Customer:</strong> +91 87654 32109</div>
                    <div class="delay-alert">
                        <i class="fas fa-exclamation-triangle"></i> Delayed by 2.5 hours
                    </div>
                    <button class="btn" style="margin-top: 10px;" onclick="viewConsignmentDetails('TRK002')">
                        <i class="fas fa-eye"></i> View Details
                    </button>
                </div>

                <div class="consignment-card">
                    <div class="consignment-header">
                        <div class="consignment-id">TRK003 - MH12EF9012</div>
                        <div class="status-badge status-delivered">Delivered</div>
                    </div>
                    <div><strong>Driver:</strong> Amit Sharma</div>
                    <div><strong>Route:</strong> Bangalore → Chennai</div>
                    <div><strong>Customer:</strong> +91 76543 21098</div>
                    <div><strong>Delivered:</strong> 1:45 PM (On Time)</div>
                    <button class="btn" style="margin-top: 10px;" onclick="viewConsignmentDetails('TRK003')">
                        <i class="fas fa-eye"></i> View Details
                    </button>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <button class="btn" onclick="exportReports()">
                    <i class="fas fa-download"></i> Export Reports
                </button>
                <button class="btn btn-secondary" onclick="sendBulkNotifications()">
                    <i class="fas fa-bell"></i> Send Bulk Notifications
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentTrip = null;
        let trackingInterval = null;
        let driverMap = null;
        let customerMap = null;
        let allTrips = {};

        // Tab switching functionality
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            document.querySelectorAll('.nav-tab').forEach((tab, index) => {
                if ((tabName === 'driver' && index === 0) || 
                    (tabName === 'customer' && index === 1) || 
                    (tabName === 'admin' && index === 2)) {
                    tab.classList.add('active');
                }
            });
        }

        // Enhanced route calculation with better city matching
        function calculateRouteData(startPoint, destination) {
            // Comprehensive Indian city routes with accurate distances and times
            const routes = {
                // Mumbai routes
                'mumbai-pune': { distance: 148, eta: 180 },
                'mumbai-nashik': { distance: 165, eta: 210 },
                'mumbai-aurangabad': { distance: 340, eta: 420 },
                'mumbai-nagpur': { distance: 525, eta: 660 },
                'mumbai-delhi': { distance: 1154, eta: 1440 },
                'mumbai-bangalore': { distance: 984, eta: 1200 },
                'mumbai-hyderabad': { distance: 711, eta: 900 },
                'mumbai-ahmedabad': { distance: 524, eta: 660 },
                'mumbai-surat': { distance: 264, eta: 300 },
                'mumbai-indore': { distance: 588, eta: 720 },
                
                // Delhi routes
                'delhi-jaipur': { distance: 280, eta: 300 },
                'delhi-agra': { distance: 233, eta: 270 },
                'delhi-chandigarh': { distance: 243, eta: 300 },
                'delhi-lucknow': { distance: 553, eta: 660 },
                'delhi-mumbai': { distance: 1154, eta: 1440 },
                'delhi-kolkata': { distance: 1472, eta: 1800 },
                'delhi-bangalore': { distance: 2077, eta: 2520 },
                'delhi-gurgaon': { distance: 32, eta: 60 },
                'delhi-noida': { distance: 25, eta: 45 },
                'delhi-faridabad': { distance: 29, eta: 50 },
                
                // Bangalore routes
                'bangalore-chennai': { distance: 346, eta: 420 },
                'bangalore-hyderabad': { distance: 569, eta: 720 },
                'bangalore-mumbai': { distance: 984, eta: 1200 },
                'bangalore-pune': { distance: 741, eta: 900 },
                'bangalore-kochi': { distance: 460, eta: 600 },
                'bangalore-mysore': { distance: 144, eta: 180 },
                'bangalore-coimbatore': { distance: 362, eta: 450 },
                
                // Chennai routes
                'chennai-bangalore': { distance: 346, eta: 420 },
                'chennai-hyderabad': { distance: 627, eta: 780 },
                'chennai-coimbatore': { distance: 507, eta: 600 },
                'chennai-madurai': { distance: 462, eta: 540 },
                'chennai-pondicherry': { distance: 162, eta: 180 },
                'chennai-salem': { distance: 342, eta: 420 },
                
                // Pune routes
                'pune-mumbai': { distance: 148, eta: 180 },
                'pune-nashik': { distance: 210, eta: 240 },
                'pune-aurangabad': { distance: 239, eta: 300 },
                'pune-bangalore': { distance: 741, eta: 900 },
                'pune-goa': { distance: 464, eta: 600 },
                'pune-kolhapur': { distance: 230, eta: 300 },
                
                // Hyderabad routes
                'hyderabad-bangalore': { distance: 569, eta: 720 },
                'hyderabad-chennai': { distance: 627, eta: 780 },
                'hyderabad-mumbai': { distance: 711, eta: 900 },
                'hyderabad-pune': { distance: 559, eta: 720 },
                'hyderabad-vijayawada': { distance: 275, eta: 330 },
                
                // Kolkata routes
                'kolkata-delhi': { distance: 1472, eta: 1800 },
                'kolkata-mumbai': { distance: 1968, eta: 2400 },
                'kolkata-bhubaneswar': { distance: 442, eta: 540 },
                'kolkata-guwahati': { distance: 1031, eta: 1260 },
                
                // Ahmedabad routes
                'ahmedabad-mumbai': { distance: 524, eta: 660 },
                'ahmedabad-delhi': { distance: 934, eta: 1140 },
                'ahmedabad-jaipur': { distance: 389, eta: 480 },
                'ahmedabad-surat': { distance: 263, eta: 300 },
                
                // Jaipur routes
                'jaipur-delhi': { distance: 280, eta: 300 },
                'jaipur-agra': { distance: 240, eta: 300 },
                'jaipur-ahmedabad': { distance: 389, eta: 480 },
                'jaipur-jodhpur': { distance: 337, eta: 420 }
            };
            
            // Enhanced city name normalization with better matching
            function normalizeCity(city) {
                const normalized = city.toLowerCase()
                    .replace(/\s+/g, '')
                    .replace(/(central|station|airport|junction|city|new|old|greater|metro)/g, '')
                    .replace(/[^a-z]/g, '')
                    .trim();
                
                // Handle common variations
                const variations = {
                    'bengaluru': 'bangalore',
                    'kolkata': 'calcutta',
                    'mumbai': 'bombay',
                    'chennai': 'madras',
                    'thiruvananthapuram': 'trivandrum',
                    'kochi': 'cochin',
                    'vadodara': 'baroda',
                    'mysuru': 'mysore'
                };
                
                return variations[normalized] || normalized;
            }
            
            const normalizedStart = normalizeCity(startPoint);
            const normalizedDest = normalizeCity(destination);
            
            console.log(`Calculating route: ${normalizedStart} → ${normalizedDest}`);
            
            // Try to find exact route match
            let routeKey = `${normalizedStart}-${normalizedDest}`;
            let routeData = routes[routeKey];
            
            // Try reverse route
            if (!routeData) {
                routeKey = `${normalizedDest}-${normalizedStart}`;
                routeData = routes[routeKey];
            }
            
            // If exact match found, return it
            if (routeData) {
                console.log(`Found exact route: ${routeKey}`, routeData);
                return {
                    distance: routeData.distance,
                    eta: routeData.eta
                };
            }
            
            // Enhanced city coordinates with more cities
            const cityCoordinates = {
                'mumbai': { lat: 19.0760, lng: 72.8777 },
                'delhi': { lat: 28.7041, lng: 77.1025 },
                'bangalore': { lat: 12.9716, lng: 77.5946 },
                'chennai': { lat: 13.0827, lng: 80.2707 },
                'pune': { lat: 18.5204, lng: 73.8567 },
                'hyderabad': { lat: 17.3850, lng: 78.4867 },
                'kolkata': { lat: 22.5726, lng: 88.3639 },
                'ahmedabad': { lat: 23.0225, lng: 72.5714 },
                'jaipur': { lat: 26.9124, lng: 75.7873 },
                'lucknow': { lat: 26.8467, lng: 80.9462 },
                'chandigarh': { lat: 30.7333, lng: 76.7794 },
                'agra': { lat: 27.1767, lng: 78.0081 },
                'nashik': { lat: 19.9975, lng: 73.7898 },
                'aurangabad': { lat: 19.8762, lng: 75.3433 },
                'nagpur': { lat: 21.1458, lng: 79.0882 },
                'coimbatore': { lat: 11.0168, lng: 76.9558 },
                'madurai': { lat: 9.9252, lng: 78.1198 },
                'kochi': { lat: 9.9312, lng: 76.2673 },
                'surat': { lat: 21.1702, lng: 72.8311 },
                'indore': { lat: 22.7196, lng: 75.8577 },
                'gurgaon': { lat: 28.4595, lng: 77.0266 },
                'noida': { lat: 28.5355, lng: 77.3910 },
                'faridabad': { lat: 28.4089, lng: 77.3178 },
                'mysore': { lat: 12.2958, lng: 76.6394 },
                'pondicherry': { lat: 11.9416, lng: 79.8083 },
                'salem': { lat: 11.6643, lng: 78.1460 },
                'goa': { lat: 15.2993, lng: 74.1240 },
                'kolhapur': { lat: 16.7050, lng: 74.2433 },
                'vijayawada': { lat: 16.5062, lng: 80.6480 },
                'bhubaneswar': { lat: 20.2961, lng: 85.8245 },
                'guwahati': { lat: 26.1445, lng: 91.7362 },
                'jodhpur': { lat: 26.2389, lng: 73.0243 }
            };
            
            // Find matching cities with fuzzy matching
            let startCity = null, destCity = null;
            
            for (let city in cityCoordinates) {
                // Exact match or contains
                if (normalizedStart === city || normalizedStart.includes(city) || city.includes(normalizedStart)) {
                    startCity = cityCoordinates[city];
                    console.log(`Matched start city: ${city}`);
                }
                if (normalizedDest === city || normalizedDest.includes(city) || city.includes(normalizedDest)) {
                    destCity = cityCoordinates[city];
                    console.log(`Matched dest city: ${city}`);
                }
            }
            
            // Calculate distance using Haversine formula if cities found
            if (startCity && destCity) {
                const R = 6371; // Earth's radius in km
                const dLat = (destCity.lat - startCity.lat) * Math.PI / 180;
                const dLng = (destCity.lng - startCity.lng) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                         Math.cos(startCity.lat * Math.PI / 180) * Math.cos(destCity.lat * Math.PI / 180) *
                         Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                const distance = Math.round(R * c * 1.3); // Add 30% for road distance vs straight line
                
                // Calculate ETA (50 km/h average including breaks, traffic, stops)
                const eta = Math.round(distance * 1.2); // 1.2 minutes per km
                
                console.log(`Calculated route: ${distance}km, ${eta}min`);
                return {
                    distance: distance,
                    eta: eta
                };
            }
            
            // Fallback with more realistic estimates
            const fallbackDistance = Math.max(80, Math.min(1500, 
                (startPoint.length + destination.length) * 15 + 120
            ));
            
            console.log(`Fallback calculation: ${fallbackDistance}km`);
            return {
                distance: fallbackDistance,
                eta: Math.round(fallbackDistance * 1.2)
            };
        }

        // Driver Portal Functions
        function startTrip() {
            const driverName = document.getElementById('driverName').value.trim();
            const vehicleNumber = document.getElementById('vehicleNumber').value.trim();
            const startPoint = document.getElementById('startPoint').value.trim();
            const destination = document.getElementById('destination').value.trim();
            const customerContact = document.getElementById('customerContact').value.trim();

            if (!driverName || !vehicleNumber || !startPoint || !destination || !customerContact) {
                alert('Please fill in all fields before starting the trip');
                return;
            }

            if (currentTrip) {
                alert('A trip is already active. Please end the current trip first.');
                return;
            }

            // Generate tracking ID
            const trackingId = 'TRK' + Math.random().toString(36).substr(2, 6).toUpperCase();
            
            // Calculate realistic distance and ETA based on route
            const routeData = calculateRouteData(startPoint, destination);
            
            currentTrip = {
                id: trackingId,
                driver: driverName,
                vehicle: vehicleNumber,
                start: startPoint,
                destination: destination,
                customer: customerContact,
                status: 'enroute',
                startTime: new Date(),
                distance: routeData.distance,
                eta: routeData.eta
            };

            // Store trip data in multiple places for reliability
            allTrips[trackingId] = { ...currentTrip };
            allTrips[trackingId.toLowerCase()] = { ...currentTrip };
            
            // Store with multiple key formats for better retrieval
            window.localStorage.setItem('trip_' + trackingId, JSON.stringify(currentTrip));
            window.localStorage.setItem('trip_' + trackingId.toLowerCase(), JSON.stringify(currentTrip));
            window.localStorage.setItem(trackingId, JSON.stringify(currentTrip));
            window.localStorage.setItem(trackingId.toLowerCase(), JSON.stringify(currentTrip));
            window.localStorage.setItem('activeTrips', JSON.stringify(allTrips));
            
            // Also store current trip separately for immediate access
            window.localStorage.setItem('currentActiveTrip', JSON.stringify(currentTrip));

            // Show trip details
            document.getElementById('tripDetails').style.display = 'block';
            document.getElementById('tripDistance').textContent = currentTrip.distance + ' km';
            document.getElementById('tripETA').textContent = Math.floor(currentTrip.eta / 60) + 'h ' + (currentTrip.eta % 60) + 'm';
            
            // Generate tracking link with proper URL structure
            const baseUrl = window.location.href.split('?')[0];
            const trackingLink = `${baseUrl}?track=${trackingId}`;
            document.getElementById('trackingLink').value = trackingLink;

            // Initialize map
            initializeDriverMap();
            
            // Start location tracking
            startLocationTracking();

            alert(`Trip started successfully!\n\nTracking ID: ${trackingId}\nShare the tracking link with your customer for live updates.`);
        }

        function initializeDriverMap() {
            const mapDiv = document.getElementById('driverMap');
            
            // Create interactive map with route visualization
            mapDiv.innerHTML = `
                <div style="height: 100%; background: #f0f8ff; position: relative; border: 2px solid #667eea; border-radius: 10px;">
                    <div style="position: absolute; top: 10px; left: 10px; right: 10px; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 10;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <div style="width: 12px; height: 12px; background: #28a745; border-radius: 50%; margin-right: 8px;"></div>
                            <strong>From:</strong> <span style="margin-left: 5px; color: #333;">${currentTrip.start}</span>
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <div style="width: 12px; height: 12px; background: #dc3545; border-radius: 50%; margin-right: 8px;"></div>
                            <strong>To:</strong> <span style="margin-left: 5px; color: #333;">${currentTrip.destination}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: #666;">
                            <span><i class="fas fa-route"></i> ${currentTrip.distance} km</span>
                            <span><i class="fas fa-clock"></i> ${Math.floor(currentTrip.eta / 60)}h ${currentTrip.eta % 60}m</span>
                            <span><i class="fas fa-truck"></i> ${currentTrip.vehicle}</span>
                        </div>
                    </div>
                    
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #667eea;">
                        <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                            <i class="fas fa-map-marked-alt" style="font-size: 3rem; margin-bottom: 15px; color: #667eea;"></i><br>
                            <strong style="color: #333;">Live GPS Tracking Active</strong><br>
                            <small style="color: #666;">Driver: ${currentTrip.driver}</small><br>
                            <div style="margin-top: 10px; padding: 8px; background: #e7f3ff; border-radius: 5px; font-size: 0.9rem;">
                                <i class="fas fa-location-arrow" style="color: #667eea;"></i> 
                                <span id="liveLocation">Starting journey...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Route visualization -->
                    <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                        <defs>
                            <linearGradient id="routeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#28a745;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#dc3545;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <path d="M 50 120 Q 200 180 350 120" stroke="url(#routeGradient)" stroke-width="4" fill="none" stroke-dasharray="10,5"/>
                        <circle cx="50" cy="120" r="8" fill="#28a745"/>
                        <circle cx="350" cy="120" r="8" fill="#dc3545"/>
                        <circle cx="120" cy="150" r="6" fill="#667eea" class="truck-position">
                            <animate attributeName="cx" values="50;120;200;280;350" dur="30s" repeatCount="indefinite"/>
                        </circle>
                    </svg>
                </div>
            `;
        }

        function startLocationTracking() {
            let locationIndex = 0;
            const locations = [
                `Starting from ${currentTrip.start}`,
                `Exited ${currentTrip.start} - On highway`,
                `Midway to ${currentTrip.destination}`,
                `Approaching ${currentTrip.destination}`,
                `Reached ${currentTrip.destination}`
            ];

            trackingInterval = setInterval(() => {
                if (locationIndex < locations.length) {
                    // Update both current location displays
                    const currentLocationElement = document.getElementById('currentLocation');
                    const liveLocationElement = document.getElementById('liveLocation');
                    
                    if (currentLocationElement) {
                        currentLocationElement.textContent = locations[locationIndex];
                    }
                    if (liveLocationElement) {
                        liveLocationElement.textContent = locations[locationIndex];
                    }
                    
                    locationIndex++;
                } else {
                    const currentLocationElement = document.getElementById('currentLocation');
                    const liveLocationElement = document.getElementById('liveLocation');
                    
                    if (currentLocationElement) {
                        currentLocationElement.textContent = `Arrived at ${currentTrip.destination}`;
                    }
                    if (liveLocationElement) {
                        liveLocationElement.textContent = `Arrived at ${currentTrip.destination}`;
                    }
                }
            }, 8000); // Update every 8 seconds for demo
        }

        function updateStatus(status) {
            if (!currentTrip) {
                alert('No active trip found. Please start a trip first.');
                return;
            }

            // Update current trip status
            currentTrip.status = status;
            currentTrip.lastUpdated = new Date();
            
            // Update stored trip data in all locations
            if (allTrips[currentTrip.id]) {
                allTrips[currentTrip.id].status = status;
                allTrips[currentTrip.id].lastUpdated = new Date();
            }
            
            // Update localStorage with all key formats
            const updatedTrip = { ...currentTrip };
            window.localStorage.setItem('trip_' + currentTrip.id, JSON.stringify(updatedTrip));
            window.localStorage.setItem('trip_' + currentTrip.id.toLowerCase(), JSON.stringify(updatedTrip));
            window.localStorage.setItem(currentTrip.id, JSON.stringify(updatedTrip));
            window.localStorage.setItem(currentTrip.id.toLowerCase(), JSON.stringify(updatedTrip));
            window.localStorage.setItem('currentActiveTrip', JSON.stringify(updatedTrip));
            window.localStorage.setItem('activeTrips', JSON.stringify(allTrips));
            
            // Update timeline - use specific driver timeline IDs
            const step1 = document.getElementById('driverStep1');
            const step2 = document.getElementById('driverStep2');
            const step3 = document.getElementById('driverStep3');
            const step4 = document.getElementById('driverStep4');
            
            // Reset all steps
            [step1, step2, step3, step4].forEach(step => {
                step.classList.remove('active');
            });
            
            if (status === 'reached') {
                step1.classList.add('completed');
                step2.classList.add('completed');
                step3.classList.add('active', 'completed');
                alert(`Status updated: Reached destination\n\nCustomers can now track this update using tracking ID: ${currentTrip.id}`);
            } else if (status === 'delivered') {
                step1.classList.add('completed');
                step2.classList.add('completed');
                step3.classList.add('completed');
                step4.classList.add('active', 'completed');
                alert(`Status updated: Delivered successfully\n\nTracking ID: ${currentTrip.id} is now marked as delivered`);
                
                // Stop location tracking when delivered
                if (trackingInterval) {
                    clearInterval(trackingInterval);
                }
            }
        }

        function endTrip() {
            if (trackingInterval) {
                clearInterval(trackingInterval);
            }
            
            // Keep trip data in allTrips for customer tracking even after ending
            if (currentTrip) {
                allTrips[currentTrip.id] = { ...currentTrip };
                alert(`Trip ended successfully!\n\nTracking ID: ${currentTrip.id} will remain available for customer tracking.`);
            }
            
            currentTrip = null;
            document.getElementById('tripDetails').style.display = 'none';
            
            // Reset form
            document.getElementById('driverName').value = '';
            document.getElementById('vehicleNumber').value = '';
            document.getElementById('startPoint').value = '';
            document.getElementById('destination').value = '';
            document.getElementById('customerContact').value = '';
        }

        function copyTrackingLink() {
            const linkInput = document.getElementById('trackingLink');
            
            if (!linkInput.value) {
                alert('No tracking link available. Please start a trip first.');
                return;
            }
            
            // Modern clipboard API with fallback
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(linkInput.value).then(() => {
                    alert('Tracking link copied to clipboard!');
                }).catch(() => {
                    // Fallback method
                    linkInput.select();
                    document.execCommand('copy');
                    alert('Tracking link copied to clipboard!');
                });
            } else {
                // Fallback for older browsers
                linkInput.select();
                linkInput.setSelectionRange(0, 99999); // For mobile devices
                document.execCommand('copy');
                alert('Tracking link copied to clipboard!');
            }
        }

        // Enhanced Customer Tracking Functions
        function trackConsignment() {
            const trackingId = document.getElementById('trackingId').value.trim().toUpperCase();
            
            if (!trackingId) {
                alert('Please enter a tracking ID');
                return;
            }

            if (trackingId.length < 6) {
                alert('Please enter a valid tracking ID (minimum 6 characters)');
                return;
            }

            let tripData = null;
            console.log(`Searching for tracking ID: ${trackingId}`);

            // Enhanced search - check multiple sources with detailed logging
            // 1. Check current active trip
            if (currentTrip && currentTrip.id.toUpperCase() === trackingId) {
                tripData = currentTrip;
                console.log('Found in current active trip:', tripData);
            }
            
            // 2. Check allTrips object (case insensitive)
            if (!tripData) {
                console.log('Checking allTrips object:', Object.keys(allTrips));
                for (let storedId in allTrips) {
                    if (storedId.toUpperCase() === trackingId) {
                        tripData = allTrips[storedId];
                        console.log('Found in allTrips:', tripData);
                        break;
                    }
                }
            }
            
            // 3. Check localStorage with comprehensive key formats
            if (!tripData) {
                try {
                    console.log('Searching localStorage...');
                    // Try all possible localStorage key formats
                    const keys = [
                        'trip_' + trackingId,
                        'trip_' + trackingId.toLowerCase(),
                        trackingId,
                        trackingId.toLowerCase(),
                        'currentActiveTrip'
                    ];
                    
                    for (let key of keys) {
                        const storedTrip = window.localStorage.getItem(key);
                        if (storedTrip) {
                            const parsedTrip = JSON.parse(storedTrip);
                            // Check if this trip matches our tracking ID
                            if (parsedTrip.id && parsedTrip.id.toUpperCase() === trackingId) {
                                tripData = parsedTrip;
                                console.log(`Found in localStorage with key "${key}":`, tripData);
                                // Restore to allTrips for future use
                                allTrips[trackingId] = tripData;
                                break;
                            }
                        }
                    }
                    
                    // Also search through activeTrips backup
                    if (!tripData) {
                        const activeTrips = window.localStorage.getItem('activeTrips');
                        if (activeTrips) {
                            const trips = JSON.parse(activeTrips);
                            console.log('Checking activeTrips backup:', Object.keys(trips));
                            for (let id in trips) {
                                if (id.toUpperCase() === trackingId) {
                                    tripData = trips[id];
                                    console.log('Found in activeTrips backup:', tripData);
                                    allTrips[trackingId] = tripData;
                                    break;
                                }
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error reading from localStorage:', e);
                }
            }
            
            // If still not found, provide better error handling
            if (!tripData) {
                console.log('Trip not found, checking available IDs...');
                
                let availableIds = [];
                
                // Collect all available tracking IDs
                if (currentTrip) {
                    availableIds.push(currentTrip.id);
                }
                
                // Add from allTrips
                availableIds = availableIds.concat(Object.keys(allTrips).filter(id => id.length >= 6));
                
                // Add from localStorage
                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('trip_')) {
                            const storedTrip = JSON.parse(localStorage.getItem(key));
                            if (storedTrip && storedTrip.id) {
                                availableIds.push(storedTrip.id);
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error scanning localStorage:', e);
                }
                
                // Remove duplicates
                availableIds = [...new Set(availableIds)];
                
                console.log('Available tracking IDs:', availableIds);
                
                let errorMessage = `❌ Tracking ID "${trackingId}" not found.\n\n🔍 Please verify:\n✓ Tracking ID is correct (case-sensitive)\n✓ Trip has been started by driver\n✓ No typos in the ID\n✓ ID format: TRK + 6 characters`;
                
                if (availableIds.length > 0) {
                    errorMessage += `\n\n📋 Available tracking IDs:\n${availableIds.join('\n')}`;
                } else {
                    errorMessage += `\n\n💡 No active trips found. Please:\n1. Ask driver to start the trip first\n2. Get the correct tracking ID from driver\n3. Try again after trip is started`;
                }
                
                alert(errorMessage);
                return;
            }

            // Show tracking results
            document.getElementById('trackingResults').style.display = 'block';
            
            // Update customer info with trip data
            document.getElementById('customerVehicle').textContent = tripData.vehicle;
            document.getElementById('customerDriver').textContent = tripData.driver;
            
            // Calculate ETA based on status
            let remainingETA = tripData.eta || 120;
            if (tripData.status === 'reached') {
                remainingETA = Math.floor(Math.random() * 30 + 10);
            } else if (tripData.status === 'delivered') {
                remainingETA = 0;
            }
            
            document.getElementById('customerETA').textContent = remainingETA > 0 ? 
                Math.floor(remainingETA / 60) + 'h ' + (remainingETA % 60) + 'm' : 'Delivered';
            
            // Update timeline and map
            updateCustomerTimeline(tripData.status);
            initializeCustomerMap(tripData);
            updateCustomerNotifications(tripData);
            
            // Success message
            const statusText = tripData.status.charAt(0).toUpperCase() + tripData.status.slice(1);
            alert(`✅ Tracking Active!\n\nID: ${trackingId}\nDriver: ${tripData.driver}\nVehicle: ${tripData.vehicle}\nRoute: ${tripData.start} → ${tripData.destination}\nStatus: ${statusText}\n\nLive updates will appear below.`);
        }

        function updateCustomerTimeline(status) {
            const steps = document.querySelectorAll('#customer .status-step');
            
            // Reset all steps
            steps.forEach(step => {
                step.classList.remove('active', 'completed');
            });
            
            // Update based on actual status
            if (status === 'started') {
                steps[0].classList.add('completed');
                steps[1].classList.add('active');
            } else if (status === 'enroute') {
                steps[0].classList.add('completed');
                steps[1].classList.add('active', 'completed');
                steps[2].classList.add('active');
            } else if (status === 'reached') {
                steps[0].classList.add('completed');
                steps[1].classList.add('completed');
                steps[2].classList.add('active', 'completed');
                steps[3].classList.add('active');
            } else if (status === 'delivered') {
                steps[0].classList.add('completed');
                steps[1].classList.add('completed');
                steps[2].classList.add('completed');
                steps[3].classList.add('completed');
            }
        }
        
        function updateCustomerNotifications(tripData) {
            const notificationPanel = document.querySelector('.notification-panel');
            const currentTime = new Date();
            const timeStr = currentTime.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
            
            let statusMessage = '';
            if (tripData.status === 'started') {
                statusMessage = `Driver ${tripData.driver} has started the journey from ${tripData.start}`;
            } else if (tripData.status === 'enroute') {
                statusMessage = `Your truck (${tripData.vehicle}) is currently en route to ${tripData.destination}`;
            } else if (tripData.status === 'reached') {
                statusMessage = `Driver has reached ${tripData.destination} and will deliver shortly`;
            } else if (tripData.status === 'delivered') {
                statusMessage = `Your consignment has been successfully delivered at ${tripData.destination}`;
            }
            
            notificationPanel.innerHTML = `
                <h3><i class="fas fa-bell"></i> Live Updates</h3>
                <div class="notification">
                    <strong>${timeStr}</strong> - ${statusMessage}
                </div>
                <div class="notification">
                    <strong>${(new Date(currentTime.getTime() - 15*60000)).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' })}</strong> - Driver ${tripData.driver} confirmed pickup from ${tripData.start}
                </div>
                <div class="notification">
                    <strong>${(new Date(currentTime.getTime() - 30*60000)).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' })}</strong> - Your consignment (${tripData.id}) has been loaded in vehicle ${tripData.vehicle}
                </div>
            `;
        }

        function initializeCustomerMap(tripData) {
            const mapDiv = document.getElementById('customerMap');
            
            let statusText = 'Your Consignment is in Transit';
            let statusColor = '#2196F3';
            
            if (tripData.status === 'delivered') {
                statusText = 'Consignment Delivered Successfully';
                statusColor = '#4CAF50';
            } else if (tripData.status === 'reached') {
                statusText = 'Driver Reached - Delivery in Progress';
                statusColor = '#FF9800';
            }
            
            mapDiv.innerHTML = `
                <div style="height: 100%; background: #f0f8ff; position: relative; border: 2px solid #2196F3; border-radius: 10px;">
                    <div style="position: absolute; top: 10px; left: 10px; right: 10px; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 10;">
                        <div style="text-align: center; margin-bottom: 10px;">
                            <strong style="color: #2196F3;">Tracking ID: ${tripData.id}</strong>
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <div style="width: 12px; height: 12px; background: #28a745; border-radius: 50%; margin-right: 8px;"></div>
                            <strong>From:</strong> <span style="margin-left: 5px; color: #333;">${tripData.start}</span>
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <div style="width: 12px; height: 12px; background: #dc3545; border-radius: 50%; margin-right: 8px;"></div>
                            <strong>To:</strong> <span style="margin-left: 5px; color: #333;">${tripData.destination}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: #666;">
                            <span><i class="fas fa-truck"></i> ${tripData.vehicle}</span>
                            <span><i class="fas fa-user-tie"></i> ${tripData.driver}</span>
                            <span><i class="fas fa-clock"></i> ETA: ${document.getElementById('customerETA').textContent}</span>
                        </div>
                    </div>
                    
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                            <i class="fas fa-truck" style="font-size: 3rem; margin-bottom: 15px; color: ${statusColor};"></i><br>
                            <strong style="color: #333; font-size: 1.2rem;">${statusText}</strong><br>
                            <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 8px; font-size: 0.95rem;">
                                <i class="fas fa-location-arrow" style="color: #2196F3;"></i> 
                                <span id="customerLiveLocation">Tracking live location...</span>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                                <i class="fas fa-info-circle"></i> Updates every few minutes
                            </div>
                        </div>
                    </div>
                    
                    <!-- Route visualization for customer -->
                    <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                        <defs>
                            <linearGradient id="customerRouteGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#4CAF50;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#2196F3;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <path d="M 60 130 Q 200 190 340 130" stroke="url(#customerRouteGradient)" stroke-width="4" fill="none" stroke-dasharray="8,4"/>
                        <circle cx="60" cy="130" r="6" fill="#4CAF50"/>
                        <circle cx="340" cy="130" r="6" fill="#2196F3"/>
                        <circle cx="150" cy="160" r="5" fill="#FF9800" class="customer-truck-position">
                            <animate attributeName="cx" values="60;150;240;300;340" dur="25s" repeatCount="indefinite"/>
                        </circle>
                    </svg>
                </div>
            `;
            
            // Start customer location updates with real trip data
            startCustomerLocationUpdates(tripData);
        }

        function startCustomerLocationUpdates(tripData) {
            const customerLocations = [
                `Journey started from ${tripData.start}`,
                `Vehicle on route to ${tripData.destination} - 75% remaining`,
                `Passed major checkpoint - 50% remaining`, 
                `Approaching ${tripData.destination} - 25% remaining`,
                `Near ${tripData.destination} - arriving soon`
            ];
            
            if (tripData.status === 'delivered') {
                customerLocations.push(`Delivered at ${tripData.destination}`);
            }
            
            let customerLocationIndex = 0;
            
            // Set initial location based on status
            if (tripData.status === 'reached') {
                customerLocationIndex = 4;
            } else if (tripData.status === 'delivered') {
                customerLocationIndex = 5;
            }
            
            const customerLiveLocationElement = document.getElementById('customerLiveLocation');
            if (customerLiveLocationElement) {
                customerLiveLocationElement.textContent = customerLocations[customerLocationIndex] || customerLocations[0];
            }
            
            // Only continue updates if not delivered
            if (tripData.status !== 'delivered') {
                setInterval(() => {
                    const customerLiveLocationElement = document.getElementById('customerLiveLocation');
                    if (customerLiveLocationElement && customerLocationIndex < customerLocations.length - 1) {
                        customerLocationIndex++;
                        customerLiveLocationElement.textContent = customerLocations[customerLocationIndex];
                    }
                }, 12000); // Update every 12 seconds
            }
        }

        // Admin Dashboard Functions
        function viewConsignmentDetails(consignmentId) {
            alert(`Viewing detailed information for consignment: ${consignmentId}\n\nThis would open a detailed popup or new page with:\n- Complete route history\n- Driver contact info\n- Customer details\n- Delivery timeline\n- Live GPS coordinates`);
        }

        // Filter functionality for admin dashboard
        function applyFilters() {
            const vehicleFilter = document.getElementById('vehicleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            
            const consignmentCards = document.querySelectorAll('.consignment-card');
            
            consignmentCards.forEach(card => {
                const cardText = card.textContent.toLowerCase();
                const vehicleMatch = !vehicleFilter || cardText.includes(vehicleFilter.toLowerCase());
                const statusMatch = !statusFilter || cardText.includes(statusFilter);
                const searchMatch = !searchFilter || cardText.includes(searchFilter);
                
                if (vehicleMatch && statusMatch && searchMatch) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Add event listeners for filters
        document.addEventListener('DOMContentLoaded', function() {
            const vehicleFilter = document.getElementById('vehicleFilter');
            const statusFilter = document.getElementById('statusFilter');
            const searchFilter = document.getElementById('searchFilter');
            
            if (vehicleFilter) vehicleFilter.addEventListener('change', applyFilters);
            if (statusFilter) statusFilter.addEventListener('change', applyFilters);
            if (searchFilter) searchFilter.addEventListener('input', applyFilters);
        });

        function exportReports() {
            // Create a sample CSV content
            const csvContent = `Consignment ID,Driver,Vehicle,Route,Status,ETA
TRK001,Rajesh Kumar,MH12AB1234,Mumbai → Pune,En Route,2:30 PM
TRK002,Suresh Patil,MH12CD5678,Delhi → Jaipur,Started,Delayed
TRK003,Amit Sharma,MH12EF9012,Bangalore → Chennai,Delivered,Completed`;

            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'consignment_report.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('Report exported successfully!');
        }

        function sendBulkNotifications() {
            alert('Bulk notifications sent to all customers with active consignments!');
        }

        // Initialize app and handle tracking links
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initializing...');
            
            // Load existing trip data from localStorage
            try {
                const storedActiveTrips = window.localStorage.getItem('activeTrips');
                if (storedActiveTrips) {
                    const trips = JSON.parse(storedActiveTrips);
                    Object.assign(allTrips, trips);
                    console.log('Loaded existing trips:', Object.keys(allTrips));
                }
                
                // Check for current active trip
                const storedCurrentTrip = window.localStorage.getItem('currentActiveTrip');
                if (storedCurrentTrip) {
                    const trip = JSON.parse(storedCurrentTrip);
                    if (trip && trip.id) {
                        currentTrip = trip;
                        allTrips[trip.id] = trip;
                        console.log('Restored current active trip:', currentTrip.id);
                        
                        // Show trip details if we have an active trip
                        document.getElementById('tripDetails').style.display = 'block';
                        document.getElementById('tripDistance').textContent = currentTrip.distance + ' km';
                        document.getElementById('tripETA').textContent = Math.floor(currentTrip.eta / 60) + 'h ' + (currentTrip.eta % 60) + 'm';
                        
                        // Restore form data
                        if (document.getElementById('driverName')) document.getElementById('driverName').value = currentTrip.driver || '';
                        if (document.getElementById('vehicleNumber')) document.getElementById('vehicleNumber').value = currentTrip.vehicle || '';
                        if (document.getElementById('startPoint')) document.getElementById('startPoint').value = currentTrip.start || '';
                        if (document.getElementById('destination')) document.getElementById('destination').value = currentTrip.destination || '';
                        if (document.getElementById('customerContact')) document.getElementById('customerContact').value = currentTrip.customer || '';
                        
                        // Generate tracking link
                        const baseUrl = window.location.href.split('?')[0];
                        const trackingLink = `${baseUrl}?track=${currentTrip.id}`;
                        if (document.getElementById('trackingLink')) {
                            document.getElementById('trackingLink').value = trackingLink;
                        }
                        
                        // Initialize map and tracking
                        initializeDriverMap();
                        startLocationTracking();
                    }
                }
            } catch (e) {
                console.error('Error loading stored trip data:', e);
            }
            
            // Check for tracking parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            const trackingId = urlParams.get('track');
            
            if (trackingId) {
                console.log('Found tracking ID in URL:', trackingId);
                
                // Switch to customer tab immediately
                showTab('customer');
                
                // Wait for DOM elements to be ready
                setTimeout(() => {
                    const trackingInput = document.getElementById('trackingId');
                    if (trackingInput) {
                        trackingInput.value = trackingId.toUpperCase();
                        console.log('Auto-filled tracking ID:', trackingInput.value);
                        
                        // Auto-trigger tracking after a short delay
                        setTimeout(() => {
                            console.log('Auto-tracking consignment...');
                            trackConsignment();
                        }, 300);
                    }
                }, 100);
            }
        });

        // Simulate real-time updates
        setInterval(() => {
            // Update ETA and location for active trips
            if (currentTrip && currentTrip.status !== 'delivered') {
                const etaElement = document.getElementById('tripETA');
                if (etaElement && currentTrip.eta > 0) {
                    currentTrip.eta -= 1;
                    etaElement.textContent = Math.floor(currentTrip.eta / 60) + 'h ' + (currentTrip.eta % 60) + 'm';
                }
            }
        }, 60000); // Update every minute
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97c65a5fc3647a16',t:'MTc1NzQxNzQyMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>